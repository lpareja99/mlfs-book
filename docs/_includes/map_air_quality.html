<style>
  #aq-map {
    width: 100%;
    height: 420px;
    border-radius: 8px;
    border: 1px solid #ddd;
    margin-bottom: 1rem;
  }

  #aq-station-details {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    font-size: 0.9rem;
    margin-top: 0.75rem;
  }

  #aq-station-details h3 {
    margin: 0 0 0.25rem 0;
    font-size: 1rem;
  }

  #aq-station-details p {
    margin: 0.15rem 0;
  }

  #aq-station-select {
    margin: 0.5rem 0 0.75rem 0;
    padding: 0.35rem 0.6rem;
    border-radius: 4px;
    border: 1px solid #cbd5e1;
    font-size: 0.9rem;
  }

  #aq-station-images {
    margin-top: 0.75rem;
    display: flex;
    flex-wrap: nowrap;    
    gap: 1rem;
  }

  #aq-station-images figure {
    margin: 0;
    flex: 1 1 0;      
    min-width: 0;
  }

  #aq-station-images img {
    width: 100%;        
    height: auto;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    display: block;
  }

  #aq-station-images figcaption {
    font-size: 0.8rem;
    margin-top: 0.25rem;
  }

  .aq-marker {
    background: #7c8db1;           /* azul */
    border-radius: 999px;
    border: 2px solid #ffffff;     /* halo blanco */
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.4);
    width: 18px;
    height: 18px;
    transform: translate(-9px, -9px); /* centrar en la coordenada */
  }

  .aq-marker-selected {
    background: #32ca24;           /* rojo para seleccionado */
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.5);
    width: 22px;
    height: 22px;
    transform: translate(-11px, -11px);
  }

  .leaflet-marker-icon.aq-marker {
    background-color: #7c8db1;
    background-image: none !important;   /* <- quita el icono azul */
    border-radius: 999px;
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.4);
    width: 18px;
    height: 18px;
    transform: translate(-9px, -9px);
  }

  .leaflet-marker-icon.aq-marker-selected {
    background-color: #32ca24;
    background-image: none !important;
    box-shadow: 0 0 0 3px rgba(50, 202, 36, 0.5);
    width: 22px;
    height: 22px;
    transform: translate(-11px, -11px);
  }
</style>

<h2>Monitoring Stations</h2>
<p>
  Interactive map of the air quality monitoring stations. Use the dropdown or click
  on a marker to see details and open the live AQICN page.
</p>

<label for="aq-station-select"><strong>Select station:</strong></label>
<select id="aq-station-select">
  <option value="">– Select –</option>
</select>

<div id="aq-map"></div>

<div id="aq-station-details">
  <h3>No station selected</h3>
  <p>Click on any marker or use the dropdown above.</p>
</div>

<!-- NEW: container for the PNGs -->
<div id="aq-station-images">
  <p>No station selected.</p>
</div>

<!-- Leaflet CSS & JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  // Carga stations.json con fetch. Jekyll resolverá la URL correcta.
  const stationsUrl = '{{ "/stations.json" | relative_url }}';

  // NEW: base path for images (folders 2850, 2855, etc.)
  const imgBaseUrl = "assets/img";

  // NUEVO: iconos para los pines
  const defaultMarkerIcon = L.divIcon({
    className: "aq-marker",
    iconSize: [18, 18]
  });

  const selectedMarkerIcon = L.divIcon({
    className: "aq-marker aq-marker-selected",
    iconSize: [22, 22]
  });


  fetch(stationsUrl)
    .then((resp) => resp.json())
    .then((stations) => {
      // Mapa centrado en Viena
      const map = L.map("aq-map").setView([48.21, 16.37], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      const details = document.getElementById("aq-station-details");
      const select = document.getElementById("aq-station-select");
      const images = document.getElementById("aq-station-images"); // NEW
      const markersByUid = {};
      let selectedMarker = null;

      function updateDetails(station) {
        details.innerHTML = `
          <h3>${station.name}</h3>
          <p><strong>Street:</strong> ${station.street}</p>
          <p><strong>City:</strong> ${station.city}, ${station.country}</p>
          <p><strong>UID:</strong> ${station.uid}</p>
          <p><a href="${station.url}" target="_blank">Open AQICN station page</a></p>
        `;
      }

      // NEW: update images for a station
      function updateImages(station) {
        if (!station) {
          images.innerHTML = "<p>No station selected.</p>";
          return;
        }

        const folder = `${imgBaseUrl}/${station.uid}`;

        images.innerHTML = `
          <figure>
            <img src="${folder}/pm25_forecast.png"
                 alt="PM2.5 forecast for ${station.name}">
            <figcaption>PM2.5 forecast</figcaption>
          </figure>
          <figure>
            <img src="${folder}/pm25_hindcast_1day.png"
                 alt="PM2.5 1-day hindcast for ${station.name}">
            <figcaption>PM2.5 1-day hindcast</figcaption>
          </figure>
        `;
      }

      // Rellena el dropdown
      stations.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.uid;
        opt.textContent = `${s.name} (${s.city})`;
        select.appendChild(opt);
      });

      // Crea marcadores
      stations.forEach((s, index) => {
        const marker = L.marker([s.lat, s.lon], { icon: defaultMarkerIcon }).addTo(map);
        marker.bindPopup(`<strong>${s.name}</strong><br/>${s.street}`);
        markersByUid[s.uid] = { marker, station: s };

        marker.on("click", () => {
          updateDetails(s);
          updateImages(s);

          // actualizar dropdown
          select.value = String(s.uid);

          // resaltar marcador seleccionado
          if (selectedMarker) {
            selectedMarker.setIcon(defaultMarkerIcon);
          }
          marker.setIcon(selectedMarkerIcon);
          selectedMarker = marker;
        });

        // Seleccionar el primero por defecto
        if (index === 0) {
          updateDetails(s);
          updateImages(s);
          select.value = String(s.uid);
          marker.setIcon(selectedMarkerIcon);
          selectedMarker = marker;
        }
      });


      // Cuando el usuario cambia el select
      select.addEventListener("change", (e) => {
        const uid = Number(e.target.value);
        if (!uid) {
          details.innerHTML = `
            <h3>No station selected</h3>
            <p>Click on any marker or use the dropdown above.</p>
          `;
          updateImages(null);

          // deseleccionar marcador
          if (selectedMarker) {
            selectedMarker.setIcon(defaultMarkerIcon);
            selectedMarker = null;
          }
          return;
        }

        const entry = markersByUid[uid];
        if (entry) {
          updateDetails(entry.station);
          updateImages(entry.station);

          // centrar mapa + popup
          map.setView(entry.marker.getLatLng(), 13);
          entry.marker.openPopup();

          // actualizar iconos
          if (selectedMarker) {
            selectedMarker.setIcon(defaultMarkerIcon);
          }
          entry.marker.setIcon(selectedMarkerIcon);
          selectedMarker = entry.marker;
        }
      });

    })
    .catch((err) => {
      console.error("Error loading stations.json", err);
      const details = document.getElementById("aq-station-details");
      details.innerHTML = "<p style='color:red;'>Error loading stations metadata.</p>";
    });
</script>
