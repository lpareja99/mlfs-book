<style>
  #aq-map {
    width: 100%;
    height: 420px;
    border-radius: 8px;
    border: 1px solid #ddd;
    margin-bottom: 1rem;
  }

  #aq-station-details {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    font-size: 0.9rem;
    margin-top: 0.75rem;
  }

  #aq-station-details h3 {
    margin: 0 0 0.25rem 0;
    font-size: 1rem;
  }

  #aq-station-details p {
    margin: 0.15rem 0;
  }

  #aq-station-select {
    margin: 0.5rem 0 0.75rem 0;
    padding: 0.35rem 0.6rem;
    border-radius: 4px;
    border: 1px solid #cbd5e1;
    font-size: 0.9rem;
  }
</style>

<h2>Monitoring Stations</h2>
<p>
  Interactive map of the air quality monitoring stations. Use the dropdown or click
  on a marker to see details and open the live AQICN page.
</p>

<label for="aq-station-select"><strong>Select station:</strong></label>
<select id="aq-station-select">
  <option value="">– Select –</option>
</select>

<div id="aq-map"></div>

<div id="aq-station-details">
  <h3>No station selected</h3>
  <p>Click on any marker or use the dropdown above.</p>
</div>

<!-- Leaflet CSS & JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  // Carga stations.json con fetch. Jekyll resolverá la URL correcta.
  const stationsUrl = '{{ "/stations.json" | relative_url }}';
  fetch(stationsUrl)
    .then((resp) => resp.json())
    .then((stations) => {
      // Mapa centrado en Viena
      const map = L.map("aq-map").setView([48.21, 16.37], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      const details = document.getElementById("aq-station-details");
      const select = document.getElementById("aq-station-select");
      const markersByUid = {};

      function updateDetails(station) {
        details.innerHTML = `
          <h3>${station.name}</h3>
          <p><strong>Street:</strong> ${station.street}</p>
          <p><strong>City:</strong> ${station.city}, ${station.country}</p>
          <p><strong>UID:</strong> ${station.uid}</p>
          <p><a href="${station.url}" target="_blank">Open AQICN station page</a></p>
        `;
      }

      // Rellena el dropdown
      stations.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.uid;
        opt.textContent = `${s.name} (${s.city})`;
        select.appendChild(opt);
      });

      // Crea marcadores
      stations.forEach((s, index) => {
        const marker = L.marker([s.lat, s.lon]).addTo(map);
        marker.bindPopup(`<strong>${s.name}</strong><br/>${s.street}`);
        markersByUid[s.uid] = { marker, station: s };

        marker.on("click", () => {
          updateDetails(s);
          select.value = String(s.uid);
        });

        // Selecciona el primero por defecto
        if (index === 0) {
          updateDetails(s);
          select.value = String(s.uid);
        }
      });

      // Cuando el usuario cambia el select
      select.addEventListener("change", (e) => {
        const uid = Number(e.target.value);
        if (!uid) {
          details.innerHTML = `
            <h3>No station selected</h3>
            <p>Click on any marker or use the dropdown above.</p>
          `;
          return;
        }
        const entry = markersByUid[uid];
        if (entry) {
          updateDetails(entry.station);
          map.setView(entry.marker.getLatLng(), 13);
          entry.marker.openPopup();
        }
      });
    })
    .catch((err) => {
      console.error("Error loading stations.json", err);
      const details = document.getElementById("aq-station-details");
      details.innerHTML = "<p style='color:red;'>Error loading stations metadata.</p>";
    });
</script>

